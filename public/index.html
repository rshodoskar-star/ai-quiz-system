<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ V2 - AI Quiz System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Cairo', 'Tajawal', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #ffffff;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .version {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
        }

        .header p {
            color: #ffffff;
            font-size: 1.1em;
            opacity: 0.95;
            margin-top: 10px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Upload Screen */
        .upload-area {
            border: 3px dashed rgba(102, 126, 234, 0.5);
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-area:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.8);
            transform: scale(1.01);
        }

        .upload-area.dragover {
            background: rgba(102, 126, 234, 0.15);
            border-color: #667eea;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.3em;
            color: #333;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #666;
            margin-top: 10px;
        }

        input[type="file"] {
            display: none;
        }

        /* Progress Bar - NEW! */
        .progress-container {
            margin: 30px 0;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .progress-message {
            text-align: center;
            margin-top: 15px;
            color: #333;
            font-size: 1.1em;
            font-weight: 500;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            font-size: 0.85em;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            padding: 10px 5px;
            color: #999;
            position: relative;
        }

        .progress-step.completed {
            color: #667eea;
            font-weight: bold;
        }

        .progress-step.active {
            color: #764ba2;
            font-weight: bold;
        }

        .progress-step::after {
            content: 'âœ“';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            color: #10b981;
            font-size: 1.5em;
        }

        .progress-step.completed::after {
            opacity: 1;
            animation: checkmark 0.5s ease;
        }

        @keyframes checkmark {
            from { transform: translateX(-50%) scale(0); }
            to { transform: translateX(-50%) scale(1); }
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Settings Screen */
        .settings-group {
            margin-bottom: 30px;
        }

        .settings-group label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .settings-group select,
        .settings-group input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            background: white;
            color: #333;
        }

        .settings-group select:focus,
        .settings-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .info-box {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            border-right: 4px solid #3b82f6;
            margin-bottom: 30px;
            color: #1e40af;
        }

        .info-box strong {
            color: #1e3a8a;
        }

        /* Quiz Screen */
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .progress-info {
            color: #333;
            font-size: 1.1em;
        }

        .score-display {
            color: #667eea;
            font-weight: bold;
            font-size: 1.2em;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .question-card {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
        }

        .question-number {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .question-text {
            font-size: 1.3em;
            color: #333;
            line-height: 1.8;
            margin-bottom: 25px;
            font-weight: 500;
        }

        .options-list {
            list-style: none;
        }

        .option-item {
            margin-bottom: 15px;
        }

        .option-btn {
            width: 100%;
            padding: 18px;
            text-align: right;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #333;
        }

        .option-btn:hover:not(:disabled) {
            border-color: #667eea;
            background: #f8f9fa;
            transform: translateX(-5px);
        }

        .option-btn.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .option-btn.correct {
            border-color: #10b981;
            background: #d1fae5;
            animation: correctPulse 0.5s ease;
        }

        .option-btn.incorrect {
            border-color: #ef4444;
            background: #fee2e2;
            animation: shake 0.5s ease;
        }

        .option-btn:disabled {
            cursor: not-allowed;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        /* Results Screen */
        .results-container {
            text-align: center;
        }

        .score-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 30px auto;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
        }

        .score-percentage {
            font-size: 3em;
            font-weight: bold;
        }

        .score-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .score-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .detail-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .detail-label {
            color: #666;
            margin-top: 5px;
        }

        .performance-message {
            font-size: 1.5em;
            color: #333;
            font-weight: bold;
            margin: 30px 0;
        }

        /* Alert Messages */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .alert.show {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-right: 4px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-right: 4px solid #ef4444;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-right: 4px solid #3b82f6;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1em;
            margin-top: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            body { padding: 10px; }
            .card { padding: 20px; border-radius: 15px; }
            .header h1 { font-size: 1.8em; }
            .upload-area { padding: 40px 15px; }
            .btn { padding: 12px 25px; font-size: 1em; width: 100%; }
            .question-text { font-size: 1.15em; }
            .option-btn { padding: 15px; font-size: 1em; }
            .score-circle { width: 150px; height: 150px; }
            .score-percentage { font-size: 2.2em; }
            .score-details { grid-template-columns: 1fr; gap: 15px; }
            .nav-buttons { flex-direction: column; }
            .progress-steps { font-size: 0.7em; }
        }

        @media (min-width: 480px) and (max-width: 768px) {
            body { padding: 15px; }
            .card { padding: 25px; }
            .header h1 { font-size: 2em; }
            .score-circle { width: 180px; height: 180px; }
            .score-details { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ“ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</h1>
            <span class="version">V2.0 âœ¨</span>
            <p>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù„ÙØ§Øª PDF Ø¥Ù„Ù‰ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ©</p>
        </div>

        <!-- Alert Messages -->
        <div id="alertBox" class="alert"></div>

        <!-- Progress Container - NEW! -->
        <div id="progressContainer" class="progress-container">
            <div class="card">
                <h2 style="color: #333; text-align: center; margin-bottom: 20px;">
                    âš¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...
                </h2>
                
                <div class="progress-bar-wrapper">
                    <div class="progress-bar-fill" id="progressBarFill">0%</div>
                </div>
                
                <div class="progress-message" id="progressMessage">
                    Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø¯Ø¡...
                </div>

                <div class="progress-steps">
                    <div class="progress-step" id="step1">Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù</div>
                    <div class="progress-step" id="step2">Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ</div>
                    <div class="progress-step" id="step3">ØªÙ†Ø¸ÙŠÙ</div>
                    <div class="progress-step" id="step4">Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
                    <div class="progress-step" id="step5">Ø¥Ù†Ù‡Ø§Ø¡</div>
                </div>
            </div>
        </div>

        <!-- Screen 1: Upload PDF -->
        <div id="uploadScreen" class="screen active">
            <div class="card">
                <h2 style="color: #333; text-align: center; margin-bottom: 30px;">
                    ğŸ“„ Ø§Ø±ÙØ¹ Ù…Ù„Ù PDF
                </h2>

                <div class="info-box">
                    <strong>ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ Ø¨ØµÙŠØºØ© ÙˆØ§Ø¶Ø­Ø©.
                    <br><strong>âœ¨ Ø¬Ø¯ÙŠØ¯:</strong> Ø¯Ø¹Ù… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (100+ Ø³Ø¤Ø§Ù„)!
                </div>

                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF</div>
                    <div class="upload-hint">Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù ÙˆØ£ÙÙ„ØªÙ‡ Ù‡Ù†Ø§</div>
                    <input type="file" id="fileInput" accept=".pdf">
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <p style="color: #666; font-size: 0.9em;">
                        Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: 50 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª
                    </p>
                </div>
            </div>
        </div>

        <!-- Screen 2: Settings -->
        <div id="settingsScreen" class="screen">
            <div class="card">
                <h2 style="color: #333; margin-bottom: 30px;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>

                <div class="info-box">
                    <strong>âœ… ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ <span id="totalQuestionsInfo">0</span> Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!</strong>
                </div>

                <div class="settings-group">
                    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
                    <select id="questionCount">
                        <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</option>
                        <option value="10">10 Ø£Ø³Ø¦Ù„Ø©</option>
                        <option value="20">20 Ø³Ø¤Ø§Ù„</option>
                        <option value="30">30 Ø³Ø¤Ø§Ù„</option>
                        <option value="50">50 Ø³Ø¤Ø§Ù„</option>
                        <option value="custom">Ø¹Ø¯Ø¯ Ù…Ø®ØµØµ</option>
                    </select>
                    <input type="number" id="customCount" min="1" style="display: none; margin-top: 10px;" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯">
                </div>

                <div class="settings-group">
                    <label>ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
                    <select id="questionOrder">
                        <option value="sequential">ØªØ³Ù„Ø³Ù„ÙŠ</option>
                        <option value="random">Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
                    </select>
                </div>

                <div class="settings-group">
                    <label>ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØµÙ„:</label>
                    <select id="chapterFilter">
                        <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>
                    </select>
                </div>

                <div class="settings-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="shuffleOptions">
                        <label for="shuffleOptions" style="margin: 0;">Ø®Ù„Ø· Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</label>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="showFeedback" checked>
                        <label for="showFeedback" style="margin: 0;">Ø¹Ø±Ø¶ Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©</label>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="goToUpload()">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
                    <button class="btn btn-primary" onclick="startQuiz()">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± â¡ï¸</button>
                </div>
            </div>
        </div>

        <!-- Screen 3: Quiz -->
        <div id="quizScreen" class="screen">
            <div class="card">
                <div class="quiz-header">
                    <div class="progress-info">
                        <span id="currentQuestion">1</span> / <span id="totalQuestions">0</span>
                    </div>
                    <div class="score-display">
                        Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span id="currentScore">0</span>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>

                <div class="question-card">
                    <div class="question-number" id="questionNumber"></div>
                    <div class="question-text" id="questionText"></div>
                    <ul class="options-list" id="optionsList"></ul>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="previousQuestion()" id="prevBtn">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <button class="btn btn-secondary" onclick="endQuiz()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
                    <button class="btn btn-primary" onclick="nextQuestion()" id="nextBtn">Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
                </div>
            </div>
        </div>

        <!-- Screen 4: Results -->
        <div id="resultsScreen" class="screen">
            <div class="card">
                <div class="results-container">
                    <h2 style="color: #333; margin-bottom: 30px;">ğŸ‰ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>

                    <div class="score-circle">
                        <div class="score-percentage" id="finalPercentage">0%</div>
                        <div class="score-label">Ù…Ù† 100%</div>
                    </div>

                    <div class="performance-message" id="performanceMessage"></div>

                    <div class="score-details">
                        <div class="detail-item">
                            <div class="detail-value" style="color: #10b981;" id="correctCount">0</div>
                            <div class="detail-label">Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value" style="color: #ef4444;" id="incorrectCount">0</div>
                            <div class="detail-label">Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value" id="totalCount">0</div>
                            <div class="detail-label">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
                        </div>
                    </div>

                    <div class="nav-buttons">
                        <button class="btn btn-secondary" onclick="goToUpload()">Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</button>
                        <button class="btn btn-primary" onclick="retakeQuiz()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            Â© 2025 Rashed Aldosari â€” Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø§Ù†ÙŠ. Ø§Ø¯Ø¹Ùˆ Ù„ÙŠ Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚ ğŸ¤
            <br>
            <small style="opacity: 0.8;">V2.0 - Powered by GPT-4o âš¡</small>
        </div>
    </div>

    <script>
        // ====================================
        // Global State
        // ====================================
        
        let questions = [];
        let filteredQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let answered = false;
        let settings = {};
        let currentRequestId = null;
        let progressInterval = null;

        const API_URL = window.location.origin;

        // ====================================
        // Progress Tracking - NEW!
        // ====================================

        function updateProgressSteps(progress) {
            const steps = [
                { id: 'step1', range: [0, 20] },
                { id: 'step2', range: [20, 40] },
                { id: 'step3', range: [40, 55] },
                { id: 'step4', range: [55, 95] },
                { id: 'step5', range: [95, 100] }
            ];

            steps.forEach(step => {
                const element = document.getElementById(step.id);
                if (progress > step.range[1]) {
                    element.classList.add('completed');
                    element.classList.remove('active');
                } else if (progress >= step.range[0] && progress <= step.range[1]) {
                    element.classList.add('active');
                    element.classList.remove('completed');
                } else {
                    element.classList.remove('active', 'completed');
                }
            });
        }

        async function pollProgress(requestId) {
            try {
                const response = await fetch(`${API_URL}/api/progress/${requestId}`);
                const data = await response.json();
                
                const progress = data.progress || 0;
                const message = data.message || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
                
                document.getElementById('progressBarFill').style.width = progress + '%';
                document.getElementById('progressBarFill').textContent = Math.round(progress) + '%';
                document.getElementById('progressMessage').textContent = message;
                
                updateProgressSteps(progress);
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                }
            } catch (error) {
                console.error('Error polling progress:', error);
            }
        }

        function showProgress(requestId) {
            currentRequestId = requestId;
            document.getElementById('uploadScreen').classList.remove('active');
            document.getElementById('progressContainer').classList.add('active');
            
            // Reset progress
            document.getElementById('progressBarFill').style.width = '0%';
            document.getElementById('progressBarFill').textContent = '0%';
            document.getElementById('progressMessage').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø¯Ø¡...';
            
            // Reset steps
            ['step1', 'step2', 'step3', 'step4', 'step5'].forEach(id => {
                document.getElementById(id).classList.remove('completed', 'active');
            });
            
            // Start polling
            progressInterval = setInterval(() => {
                if (currentRequestId) {
                    pollProgress(currentRequestId);
                }
            }, 500);
        }

        function hideProgress() {
            clearInterval(progressInterval);
            document.getElementById('progressContainer').classList.remove('active');
        }

        // ====================================
        // Upload Screen
        // ====================================

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        async function handleFileUpload(file) {
            if (!file) return;

            if (file.type !== 'application/pdf') {
                showAlert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ù…Ù† Ù†ÙˆØ¹ PDF', 'error');
                return;
            }

            const maxSize = 50 * 1024 * 1024;
            if (file.size > maxSize) {
                showAlert('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ø£ÙƒØ¨Ø± Ù…Ù† 50 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                // Show progress
                showProgress('temp_' + Date.now());
                
                const response = await fetch(`${API_URL}/api/quiz-from-pdf`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                hideProgress();

                if (data.success) {
                    questions = data.questions;
                    currentRequestId = data.requestId;
                    
                    showAlert(`ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${data.totalQuestions} Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­! âœ…`, 'success');
                    
                    setTimeout(() => {
                        goToSettings();
                    }, 1500);
                } else {
                    showAlert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù', 'error');
                }

            } catch (error) {
                hideProgress();
                console.error('Upload error:', error);
                showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
            }
        }

        // ====================================
        // Settings Screen
        // ====================================

        function goToSettings() {
            if (!questions || questions.length === 0) {
                showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø©', 'error');
                return;
            }

            showScreen('settingsScreen');

            document.getElementById('totalQuestionsInfo').textContent = questions.length;

            const chapters = [...new Set(questions.map(q => q.chapter).filter(Boolean))];
            const chapterFilter = document.getElementById('chapterFilter');
            chapterFilter.innerHTML = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>';
            
            chapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter;
                option.textContent = chapter;
                chapterFilter.appendChild(option);
            });

            document.getElementById('questionCount').addEventListener('change', function() {
                const customInput = document.getElementById('customCount');
                customInput.style.display = this.value === 'custom' ? 'block' : 'none';
            });
        }

        function startQuiz() {
            const countSelect = document.getElementById('questionCount').value;
            const customCount = parseInt(document.getElementById('customCount').value) || 0;
            const order = document.getElementById('questionOrder').value;
            const chapter = document.getElementById('chapterFilter').value;
            const shuffle = document.getElementById('shuffleOptions').checked;
            const feedback = document.getElementById('showFeedback').checked;

            settings = { count: countSelect === 'custom' ? customCount : countSelect, order, chapter, shuffle, feedback };

            filteredQuestions = chapter === 'all' ? [...questions] : questions.filter(q => q.chapter === chapter);

            if (filteredQuestions.length === 0) {
                showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„', 'error');
                return;
            }

            if (settings.order === 'random') {
                filteredQuestions = shuffleArray(filteredQuestions);
            }

            if (settings.count !== 'all') {
                const count = parseInt(settings.count);
                filteredQuestions = filteredQuestions.slice(0, count);
            }

            if (settings.shuffle) {
                filteredQuestions = filteredQuestions.map(q => {
                    const shuffled = shuffleArrayWithIndex(q.options, q.correct);
                    return { ...q, options: shuffled.array, correct: shuffled.newIndex };
                });
            }

            currentQuestionIndex = 0;
            score = 0;
            answered = false;

            showScreen('quizScreen');
            displayQuestion();
        }

        // ====================================
        // Quiz Screen
        // ====================================

        function displayQuestion() {
            if (currentQuestionIndex >= filteredQuestions.length) {
                showResults();
                return;
            }

            const question = filteredQuestions[currentQuestionIndex];
            answered = false;

            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = filteredQuestions.length;
            document.getElementById('currentScore').textContent = score;

            const progress = ((currentQuestionIndex + 1) / filteredQuestions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            const questionNumber = question.chapter 
                ? `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1} - ${question.chapter}`
                : `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1}`;
            
            document.getElementById('questionNumber').textContent = questionNumber;
            document.getElementById('questionText').textContent = question.question;

            const optionsList = document.getElementById('optionsList');
            optionsList.innerHTML = '';

            question.options.forEach((option, index) => {
                const li = document.createElement('li');
                li.className = 'option-item';

                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = option;
                btn.onclick = () => selectAnswer(index);

                li.appendChild(btn);
                optionsList.appendChild(li);
            });

            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
        }

        function selectAnswer(selectedIndex) {
            if (answered) return;

            answered = true;
            const question = filteredQuestions[currentQuestionIndex];
            const isCorrect = selectedIndex === question.correct;

            if (isCorrect) {
                score++;
                document.getElementById('currentScore').textContent = score;
            }

            if (settings.feedback) {
                const options = document.querySelectorAll('.option-btn');
                
                options.forEach((btn, index) => {
                    btn.disabled = true;
                    
                    if (index === question.correct) {
                        btn.classList.add('correct');
                    } else if (index === selectedIndex) {
                        btn.classList.add('incorrect');
                    }
                });

                setTimeout(() => {
                    nextQuestion();
                }, 1500);
            } else {
                const selectedBtn = document.querySelectorAll('.option-btn')[selectedIndex];
                selectedBtn.classList.add('selected');
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < filteredQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                showResults();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function endQuiz() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ')) {
                showResults();
            }
        }

        // ====================================
        // Results Screen
        // ====================================

        function showResults() {
            showScreen('resultsScreen');

            const total = filteredQuestions.length;
            const incorrect = total - score;
            const percentage = Math.round((score / total) * 100);

            document.getElementById('finalPercentage').textContent = percentage + '%';
            document.getElementById('correctCount').textContent = score;
            document.getElementById('incorrectCount').textContent = incorrect;
            document.getElementById('totalCount').textContent = total;

            let message = '';
            if (percentage >= 90) {
                message = 'ğŸŒŸ Ù…Ù…ØªØ§Ø²! Ø£Ø¯Ø§Ø¡ Ø±Ø§Ø¦Ø¹ Ø¬Ø¯Ø§Ù‹!';
            } else if (percentage >= 80) {
                message = 'ğŸ‘ Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹! Ø§Ø³ØªÙ…Ø± Ø¨Ø§Ù„ØªÙ‚Ø¯Ù…!';
            } else if (percentage >= 70) {
                message = 'âœ… Ø¬ÙŠØ¯! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø³Ù† Ø£ÙƒØ«Ø±!';
            } else if (percentage >= 60) {
                message = 'ğŸ“š Ù…Ù‚Ø¨ÙˆÙ„ØŒ Ø­Ø§ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!';
            } else {
                message = 'ğŸ’ª ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©!';
            }

            document.getElementById('performanceMessage').textContent = message;
        }

        function retakeQuiz() {
            goToSettings();
        }

        // ====================================
        // Navigation
        // ====================================

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            window.scrollTo(0, 0);
        }

        function goToUpload() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©ØŸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ.')) {
                questions = [];
                filteredQuestions = [];
                fileInput.value = '';
                showScreen('uploadScreen');
            }
        }

        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = `alert alert-${type} show`;
            alertBox.textContent = message;

            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }

        // ====================================
        // Utility Functions
        // ====================================

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function shuffleArrayWithIndex(array, correctIndex) {
            const items = array.map((item, index) => ({ item, isCorrect: index === correctIndex }));
            
            for (let i = items.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [items[i], items[j]] = [items[j], items[i]];
            }

            const newArray = items.map(i => i.item);
            const newIndex = items.findIndex(i => i.isCorrect);

            return { array: newArray, newIndex };
        }

        // ====================================
        // Initialize
        // ====================================

        console.log('ğŸš€ AI Quiz System V2.0 initialized');
        console.log('âœ¨ Features: Progress Tracking, Better Mobile UI, Enhanced UX');
        console.log('API URL:', API_URL);
    </script>
</body>
</html>
