<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ - AI Quiz System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #ffffff;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: #ffffff;
            font-size: 1.1em;
            opacity: 0.95;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Upload Screen */
        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-area:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .upload-area.dragover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #ffffff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.3em;
            color: #ffffff;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: rgba(255, 255, 255, 0.8);
            margin-top: 10px;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Progress Loading - SMART VERSION */
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .progress-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 30px;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.2);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 200% 100%;
            border-radius: 20px;
            transition: width 0.3s ease;
            position: relative;
            animation: shimmer 2s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffffff;
            font-weight: bold;
            font-size: 1em;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .progress-stage {
            color: #ffffff;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
            min-height: 30px;
        }

        .loading-details {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
            margin-top: 10px;
        }

        /* Settings Screen */
        .settings-group {
            margin-bottom: 30px;
        }

        .settings-group label {
            display: block;
            color: #ffffff;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .settings-group select,
        .settings-group input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            color: #333333;
        }

        .settings-group select:focus,
        .settings-group input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            background: #ffffff;
        }

        .settings-group select option {
            background: #ffffff;
            color: #333333;
        }

        .settings-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-left: 10px;
            cursor: pointer;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            color: #ffffff;
            font-size: 1em;
            cursor: pointer;
        }

        #customCount {
            display: none;
            margin-top: 10px;
        }

        .info-box {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.4);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #ffffff;
            margin: 5px 0;
        }

        /* Quiz Screen */
        .quiz-header {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .quiz-info {
            color: #ffffff;
            font-size: 1.1em;
        }

        .quiz-progress {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 15px;
        }

        #progressBar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .question-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .question-header {
            color: #667eea;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .question-text {
            color: #333;
            font-size: 1.3em;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .options-list {
            list-style: none;
        }

        .option-item {
            margin-bottom: 15px;
        }

        .option-btn {
            width: 100%;
            padding: 15px 20px;
            text-align: right;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateX(-5px);
        }

        .option-btn.selected {
            background: #e0e7ff;
            border-color: #667eea;
        }

        .option-btn.correct {
            background: #d1fae5;
            border-color: #10b981;
        }

        .option-btn.incorrect {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .option-btn:disabled {
            cursor: not-allowed;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Results Screen */
        .results-container {
            text-align: center;
        }

        .score-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 30px auto;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
        }

        .score-percentage {
            font-size: 3em;
            font-weight: bold;
            color: #ffffff;
        }

        .score-label {
            font-size: 1em;
            color: rgba(255, 255, 255, 0.9);
        }

        .performance-message {
            font-size: 1.5em;
            color: #ffffff;
            margin: 20px 0;
            font-weight: bold;
        }

        .score-details {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .detail-item {
            text-align: center;
            padding: 20px;
        }

        .detail-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #ffffff;
        }

        .detail-label {
            font-size: 1em;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 5px;
        }

        /* Alert */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 400px;
        }

        .alert.show {
            opacity: 1;
            transform: translateY(0);
        }

        .alert-success {
            background: #10b981;
            color: white;
        }

        .alert-error {
            background: #ef4444;
            color: white;
        }

        .alert-info {
            background: #3b82f6;
            color: white;
        }

        /* Footer */
        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 40px;
            font-size: 0.9em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .card {
                padding: 25px;
            }

            .quiz-header {
                font-size: 0.9em;
            }

            .question-text {
                font-size: 1.1em;
            }

            .option-btn {
                font-size: 1em;
            }

            .score-circle {
                width: 150px;
                height: 150px;
            }

            .score-percentage {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Alert Box -->
        <div id="alertBox" class="alert"></div>

        <!-- Header -->
        <div class="header">
            <h1>ðŸŽ“ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</h1>
            <p>Ø§Ø±ÙØ¹ Ù…Ù„Ù PDF ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ø®ØªØ¨Ø§Ø± ØªÙØ§Ø¹Ù„ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
        </div>

        <!-- Screen 1: Upload -->
        <div id="uploadScreen" class="screen active">
            <div class="card">
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ðŸ“„</div>
                    <div class="upload-text">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF Ø£Ùˆ Ø§Ø³Ø­Ø¨Ù‡ Ù‡Ù†Ø§</div>
                    <div class="upload-hint">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 50 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª</div>
                </div>
                <input type="file" id="fileInput" accept=".pdf">
            </div>
        </div>

        <!-- Screen 2: Loading with Smart Progress -->
        <div id="loadingScreen" class="loading">
            <div class="card">
                <div class="progress-container">
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
                        <div class="progress-text" id="progressText">0%</div>
                    </div>
                </div>
                <div class="progress-stage" id="progressStage">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...</div>
                <div class="loading-details" id="loadingDetails">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© Ø£Ùˆ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†...</div>
            </div>
        </div>

        <!-- Screen 3: Settings -->
        <div id="settingsScreen" class="screen">
            <div class="card">
                <h2 style="color: #ffffff; margin-bottom: 30px;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>

                <div class="info-box">
                    <p>ðŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©: <strong><span id="totalQuestionsInfo">0</span></strong></p>
                </div>

                <div class="settings-group">
                    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
                    <select id="questionCount">
                        <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</option>
                        <option value="10">10 Ø£Ø³Ø¦Ù„Ø©</option>
                        <option value="20" selected>20 Ø³Ø¤Ø§Ù„</option>
                        <option value="30">30 Ø³Ø¤Ø§Ù„</option>
                        <option value="50">50 Ø³Ø¤Ø§Ù„</option>
                        <option value="custom">Ø¹Ø¯Ø¯ Ù…Ø®ØµØµ</option>
                    </select>
                    <input type="number" id="customCount" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯" min="1" max="200">
                </div>

                <div class="settings-group">
                    <label>ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØµÙ„:</label>
                    <select id="chapterFilter">
                        <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>
                    </select>
                </div>

                <div class="settings-group">
                    <label>ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
                    <select id="questionOrder">
                        <option value="random">Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
                        <option value="sequential">ØªØ³Ù„Ø³Ù„ÙŠ</option>
                    </select>
                </div>

                <div class="settings-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="shuffleOptions" checked>
                        <span>Ø®Ù„Ø· ØªØ±ØªÙŠØ¨ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</span>
                    </label>
                </div>

                <div class="settings-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="showFeedback" checked>
                        <span>Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙˆØ±Ø§Ù‹</span>
                    </label>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="goToUpload()">Ø±Ø¬ÙˆØ¹</button>
                    <button class="btn btn-primary" onclick="startQuiz()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
                </div>
            </div>
        </div>

        <!-- Screen 4: Quiz -->
        <div id="quizScreen" class="screen">
            <div class="card">
                <div class="quiz-header">
                    <div class="quiz-info">
                        Ø§Ù„Ø³Ø¤Ø§Ù„ <span id="currentQuestion">1</span> Ù…Ù† <span id="totalQuestions">20</span>
                    </div>
                    <div class="quiz-info">
                        Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="currentScore">0</span>
                    </div>
                    <div class="quiz-progress">
                        <div id="progressBar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-header" id="questionNumber">Ø§Ù„Ø³Ø¤Ø§Ù„ 1</div>
                    <div class="question-text" id="questionText"></div>

                    <ul class="options-list" id="optionsList"></ul>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <button class="btn btn-secondary" onclick="endQuiz()">Ø¥Ù†Ù‡Ø§Ø¡</button>
                    <button class="btn btn-primary" onclick="nextQuestion()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                </div>
            </div>
        </div>

        <!-- Screen 5: Results -->
        <div id="resultsScreen" class="screen">
            <div class="card">
                <div class="results-container">
                    <h2 style="color: #ffffff; margin-bottom: 30px;">ðŸŽ‰ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>

                    <div class="score-circle">
                        <div class="score-percentage" id="finalPercentage">0%</div>
                        <div class="score-label">Ù…Ù† 100%</div>
                    </div>

                    <div class="performance-message" id="performanceMessage"></div>

                    <div class="score-details">
                        <div class="detail-item">
                            <div class="detail-value" style="color: #10b981;" id="correctCount">0</div>
                            <div class="detail-label">Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value" style="color: #ef4444;" id="incorrectCount">0</div>
                            <div class="detail-label">Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value" id="totalCount">0</div>
                            <div class="detail-label">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
                        </div>
                    </div>

                    <div class="nav-buttons">
                        <button class="btn btn-secondary" onclick="goToUpload()">Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</button>
                        <button class="btn btn-primary" onclick="retakeQuiz()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            Â© 2025 Rashed Aldosari â€” Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø§Ù†ÙŠ. Ø§Ø¯Ø¹Ùˆ Ù„ÙŠ Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚ ðŸ¤
        </div>
    </div>

    <script>
        // ====================================
        // Global State
        // ====================================
        
        let questions = [];
        let filteredQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let answered = false;
        let settings = {};

        const API_URL = window.location.origin;

        // ====================================
        // Upload Screen
        // ====================================

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        // ====================================
        // Smart Progress System
        // ====================================

        const progressStages = [
            { start: 0, end: 10, speed: 0.3, text: 'رفع الملف...' },
            { start: 10, end: 25, speed: 0.2, text: 'استخراج النص من PDF...' },
            { start: 25, end: 45, speed: 0.15, text: 'تحليل المحتوى...' },
            { start: 45, end: 65, speed: 0.12, text: 'البحث عن الأسئلة...' },
            { start: 65, end: 80, speed: 0.08, text: 'استخراج الخيارات...' },
            { start: 80, end: 90, speed: 0.05, text: 'التحقق من الجودة...' }
        ];

        let currentProgress = 0;
        let currentStageIndex = 0;
        let progressInterval = null;
        let processingComplete = false;
        let progressPollInterval = null;
        let serverProgress = 0;
        let currentRequestId = null;

        function startSmartProgress() {
            currentProgress = 0;
            currentStageIndex = 0;
            processingComplete = false;
            
            const progressFill = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressText');
            const progressStage = document.getElementById('progressStage');
            
            progressFill.style.width = '0%';
            progressText.textContent = '0%';
            progressStage.textContent = progressStages[0].text;
            
            progressInterval = setInterval(() => {
                if (currentStageIndex >= progressStages.length) {
                    if (processingComplete) {
                        completeProgress();
                    }
                    return;
                }
                
                const stage = progressStages[currentStageIndex];
                const increment = stage.speed;
                
                currentProgress += increment;
                
                if (currentProgress >= stage.end) {
                    currentProgress = stage.end;
                    currentStageIndex++;
                    
                    if (currentStageIndex < progressStages.length) {
                        progressStage.textContent = progressStages[currentStageIndex].text;
                    }
                }
                
                const displayProgress = Math.max(currentProgress, serverProgress);
                progressFill.style.width = displayProgress + '%';
                progressText.textContent = Math.round(displayProgress) + '%';
                
            }, 100);
        }

        function completeProgress() {
            clearInterval(progressInterval);
            
            const progressFill = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressText');
            const progressStage = document.getElementById('progressStage');
            
            let finalProgress = currentProgress;
            const completeInterval = setInterval(() => {
                finalProgress += 2;
                if (finalProgress >= 100) {
                    finalProgress = 100;
                    clearInterval(completeInterval);
                    
                    setTimeout(() => {
                        hideLoading();
                    }, 300);
                }
                
                progressFill.style.width = finalProgress + '%';
                progressText.textContent = Math.round(finalProgress) + '%';
            }, 50);
            
            progressStage.textContent = 'âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬!';
        }

        function pollServerProgress(requestId) {
            progressPollInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${API_URL}/api/progress/${requestId}`);
                    const data = await res.json();
                    
                    if (data.progress > 0) {
                        serverProgress = data.progress;
                        
                        if (serverProgress > currentProgress) {
                            currentProgress = serverProgress;
                            document.getElementById('progressBarFill').style.width = serverProgress + '%';
                            document.getElementById('progressText').textContent = Math.round(serverProgress) + '%';
                        }
                        
                        if (data.message) {
                            document.getElementById('progressStage').textContent = data.message;
                        }
                    }
                    
                    if (data.progress >= 100) {
                        clearInterval(progressPollInterval);
                        processingComplete = true;
                    }
                    
                    if (data.error) {
                        clearInterval(progressPollInterval);
                        clearInterval(progressInterval);
                        hideLoading();
                        showAlert(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', 'error');
                    }
                } catch (err) {
                    console.error('Poll error:', err);
                }
            }, 1000);
        }

        function stopProgressPolling() {
            if (progressPollInterval) {
                clearInterval(progressPollInterval);
                progressPollInterval = null;
            }
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        // ====================================
        // File Upload Handler
        // ====================================

        async function handleFileUpload(file) {
            if (!file) return;

            if (file.type !== 'application/pdf') {
                showAlert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ù…Ù† Ù†ÙˆØ¹ PDF', 'error');
                return;
            }

            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                showAlert('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ø£ÙƒØ¨Ø± Ù…Ù† 50 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª', 'error');
                return;
            }

            // Start smart progress
            currentRequestId = `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            showLoading();
            startSmartProgress();
            pollServerProgress(currentRequestId);

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_URL}/api/quiz-from-pdf`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Request-ID': currentRequestId
                    }
                });

                const data = await response.json();

                // Mark processing as complete
                processingComplete = true;

                // Wait for progress to complete
                await new Promise(resolve => setTimeout(resolve, 500));

                if (data.success) {
                    questions = data.questions;
                    showAlert(`ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${data.totalQuestions} Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­! âœ…`, 'success');
                    
                    setTimeout(() => {
                        goToSettings();
                    }, 1500);
                } else {
                    hideLoading();
                    showAlert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù', 'error');
                }

            } catch (error) {
                console.error('Upload error:', error);
                stopProgressPolling();
                stopProgressPolling();
                hideLoading();
                showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
            }
        }

        // ====================================
        // Settings Screen
        // ====================================

        function goToSettings() {
            if (!questions || questions.length === 0) {
                showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø©', 'error');
                return;
            }

            showScreen('settingsScreen');

            document.getElementById('totalQuestionsInfo').textContent = questions.length;

            // Populate chapters
            const chapters = [...new Set(questions.map(q => q.chapter).filter(Boolean))];
            const chapterFilter = document.getElementById('chapterFilter');
            chapterFilter.innerHTML = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>';
            
            chapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter;
                option.textContent = chapter;
                chapterFilter.appendChild(option);
            });

            // Custom count toggle
            document.getElementById('questionCount').addEventListener('change', function() {
                const customInput = document.getElementById('customCount');
                customInput.style.display = this.value === 'custom' ? 'block' : 'none';
            });
        }

        function startQuiz() {
            // Get settings
            const countSelect = document.getElementById('questionCount').value;
            const customCount = parseInt(document.getElementById('customCount').value) || 0;
            const order = document.getElementById('questionOrder').value;
            const chapter = document.getElementById('chapterFilter').value;
            const shuffle = document.getElementById('shuffleOptions').checked;
            const feedback = document.getElementById('showFeedback').checked;

            settings = {
                count: countSelect === 'custom' ? customCount : countSelect,
                order,
                chapter,
                shuffle,
                feedback
            };

            // Filter questions by chapter
            filteredQuestions = chapter === 'all' 
                ? [...questions] 
                : questions.filter(q => q.chapter === chapter);

            if (filteredQuestions.length === 0) {
                showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„', 'error');
                return;
            }

            // Shuffle if random
            if (settings.order === 'random') {
                filteredQuestions = shuffleArray(filteredQuestions);
            }

            // Limit count
            if (settings.count !== 'all') {
                const count = parseInt(settings.count);
                filteredQuestions = filteredQuestions.slice(0, count);
            }

            // Shuffle options if enabled
            if (settings.shuffle) {
                filteredQuestions = filteredQuestions.map(q => {
                    const shuffled = shuffleArrayWithIndex(q.options, q.correct);
                    return {
                        ...q,
                        options: shuffled.array,
                        correct: shuffled.newIndex
                    };
                });
            }

            // Reset state
            currentQuestionIndex = 0;
            score = 0;
            answered = false;

            // Show quiz
            showScreen('quizScreen');
            displayQuestion();
        }

        // ====================================
        // Quiz Screen
        // ====================================

        function displayQuestion() {
            if (currentQuestionIndex >= filteredQuestions.length) {
                showResults();
                return;
            }

            const question = filteredQuestions[currentQuestionIndex];
            answered = false;

            // Update header
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = filteredQuestions.length;
            document.getElementById('currentScore').textContent = score;

            // Update progress
            const progress = ((currentQuestionIndex + 1) / filteredQuestions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            // Update question
            const questionNumber = question.chapter 
                ? `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1} - ${question.chapter}`
                : `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1}`;
            
            document.getElementById('questionNumber').textContent = questionNumber;
            document.getElementById('questionText').textContent = question.question;

            // Display options
            const optionsList = document.getElementById('optionsList');
            optionsList.innerHTML = '';

            question.options.forEach((option, index) => {
                const li = document.createElement('li');
                li.className = 'option-item';

                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = option;
                btn.onclick = () => selectAnswer(index);

                li.appendChild(btn);
                optionsList.appendChild(li);
            });

            // Update buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
        }

        function selectAnswer(selectedIndex) {
            if (answered) return;

            answered = true;
            const question = filteredQuestions[currentQuestionIndex];
            const isCorrect = selectedIndex === question.correct;

            if (isCorrect) {
                score++;
                document.getElementById('currentScore').textContent = score;
            }

            // Show feedback if enabled
            if (settings.feedback) {
                const options = document.querySelectorAll('.option-btn');
                
                options.forEach((btn, index) => {
                    btn.disabled = true;
                    
                    if (index === question.correct) {
                        btn.classList.add('correct');
                    } else if (index === selectedIndex) {
                        btn.classList.add('incorrect');
                    }
                });

                // Auto advance after 1.5 seconds
                setTimeout(() => {
                    nextQuestion();
                }, 1500);
            } else {
                // Just mark selected
                const selectedBtn = document.querySelectorAll('.option-btn')[selectedIndex];
                selectedBtn.classList.add('selected');
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < filteredQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                showResults();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function endQuiz() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ')) {
                showResults();
            }
        }

        // ====================================
        // Results Screen
        // ====================================

        function showResults() {
            showScreen('resultsScreen');

            const total = filteredQuestions.length;
            const incorrect = total - score;
            const percentage = Math.round((score / total) * 100);

            document.getElementById('finalPercentage').textContent = percentage + '%';
            document.getElementById('correctCount').textContent = score;
            document.getElementById('incorrectCount').textContent = incorrect;
            document.getElementById('totalCount').textContent = total;

            // Performance message
            let message = '';
            if (percentage >= 90) {
                message = 'ðŸŒŸ Ù…Ù…ØªØ§Ø²! Ø£Ø¯Ø§Ø¡ Ø±Ø§Ø¦Ø¹ Ø¬Ø¯Ø§Ù‹!';
            } else if (percentage >= 80) {
                message = 'ðŸ‘ Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹! Ø§Ø³ØªÙ…Ø± Ø¨Ø§Ù„ØªÙ‚Ø¯Ù…!';
            } else if (percentage >= 70) {
                message = 'âœ… Ø¬ÙŠØ¯! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø³Ù† Ø£ÙƒØ«Ø±!';
            } else if (percentage >= 60) {
                message = 'ðŸ“š Ù…Ù‚Ø¨ÙˆÙ„ØŒ Ø­Ø§ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!';
            } else {
                message = 'ðŸ’ª ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©!';
            }

            document.getElementById('performanceMessage').textContent = message;
        }

        function retakeQuiz() {
            goToSettings();
        }

        // ====================================
        // Navigation
        // ====================================

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            window.scrollTo(0, 0);
        }

        function goToUpload() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©ØŸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ.')) {
                questions = [];
                filteredQuestions = [];
                fileInput.value = '';
                showScreen('uploadScreen');
            }
        }

        function showLoading() {
            document.getElementById('loadingScreen').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingScreen').classList.remove('active');
        }

        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = `alert alert-${type} show`;
            alertBox.textContent = message;

            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }

        // ====================================
        // Utility Functions
        // ====================================

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function shuffleArrayWithIndex(array, correctIndex) {
            const items = array.map((item, index) => ({ item, isCorrect: index === correctIndex }));
            
            for (let i = items.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [items[i], items[j]] = [items[j], items[i]];
            }

            const newArray = items.map(i => i.item);
            const newIndex = items.findIndex(i => i.isCorrect);

            return { array: newArray, newIndex };
        }

        // ====================================
        // Initialize
        // ====================================

        console.log('ðŸš€ AI Quiz System initialized');
        console.log('API URL:', API_URL);
    </script>
</body>
</html>
